{
  "version": 3,
  "sources": ["../../../../../../../Users/klemo/Code/TLMR/TLMR-site/netlify/functions/google-reviews.js"],
  "sourceRoot": "/private/var/folders/56/7cv4jr916ngfxqtmd7mvqzb00000gn/T/tmp-39375-xs8pKABqTgJ2",
  "sourcesContent": ["const https = require('https');\n\n// Google OAuth token refresh\nasync function refreshAccessToken() {\n  const clientId = process.env.GOOGLE_CLIENT_ID;\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET;\n  const refreshToken = process.env.GOOGLE_REFRESH_TOKEN;\n\n  if (!clientId || !clientSecret || !refreshToken) {\n    throw new Error('Missing Google OAuth credentials in environment variables');\n  }\n\n  const params = new URLSearchParams({\n    client_id: clientId,\n    client_secret: clientSecret,\n    refresh_token: refreshToken,\n    grant_type: 'refresh_token',\n  });\n\n  return new Promise((resolve, reject) => {\n    const options = {\n      hostname: 'oauth2.googleapis.com',\n      path: '/token',\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/x-www-form-urlencoded',\n        'Content-Length': Buffer.byteLength(params.toString()),\n      },\n    };\n\n    const req = https.request(options, (res) => {\n      let data = '';\n      res.on('data', (chunk) => (data += chunk));\n      res.on('end', () => {\n        try {\n          const parsed = JSON.parse(data);\n          if (parsed.error) {\n            reject(new Error(`OAuth error: ${parsed.error_description || parsed.error}`));\n          } else {\n            resolve(parsed.access_token);\n          }\n        } catch (e) {\n          reject(new Error('Failed to parse OAuth response'));\n        }\n      });\n    });\n\n    req.on('error', reject);\n    req.write(params.toString());\n    req.end();\n  });\n}\n\n// Fetch reviews from Google My Business API v4\nasync function fetchGoogleReviews(accessToken, locationId) {\n  return new Promise((resolve, reject) => {\n    const options = {\n      hostname: 'mybusiness.googleapis.com',\n      path: `/v4/accounts/-/locations/${locationId}/reviews`,\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n      },\n    };\n\n    const req = https.request(options, (res) => {\n      let data = '';\n      res.on('data', (chunk) => (data += chunk));\n      res.on('end', () => {\n        try {\n          const parsed = JSON.parse(data);\n          if (parsed.error) {\n            reject(new Error(`GMB API error: ${parsed.error.message || JSON.stringify(parsed.error)}`));\n          } else {\n            resolve(parsed);\n          }\n        } catch (e) {\n          reject(new Error(`Failed to parse GMB response: ${data}`));\n        }\n      });\n    });\n\n    req.on('error', reject);\n    req.end();\n  });\n}\n\n// Transform GMB review data to our frontend format\nfunction transformReviews(gmbData) {\n  if (!gmbData || !gmbData.reviews) {\n    return {\n      reviews: [],\n      averageRating: 0,\n      totalReviewCount: 0,\n    };\n  }\n\n  const ratingMap = {\n    'ONE': 1,\n    'TWO': 2,\n    'THREE': 3,\n    'FOUR': 4,\n    'FIVE': 5,\n  };\n\n  const reviews = gmbData.reviews.map((review) => ({\n    reviewId: review.reviewId || review.name,\n    reviewer: {\n      displayName: review.reviewer?.displayName || 'Anonyme',\n      profilePhotoUrl: review.reviewer?.profilePhotoUrl || null,\n    },\n    starRating: ratingMap[review.starRating] || 5,\n    comment: review.comment || '',\n    createTime: review.createTime,\n    updateTime: review.updateTime,\n    reviewReply: review.reviewReply ? {\n      comment: review.reviewReply.comment,\n      updateTime: review.reviewReply.updateTime,\n    } : null,\n  }));\n\n  // Calculate average rating\n  const totalRating = reviews.reduce((sum, r) => sum + r.starRating, 0);\n  const averageRating = reviews.length > 0 ? (totalRating / reviews.length).toFixed(1) : 0;\n\n  return {\n    reviews,\n    averageRating: parseFloat(averageRating),\n    totalReviewCount: gmbData.totalReviewCount || reviews.length,\n  };\n}\n\nexports.handler = async (event) => {\n  // CORS headers\n  const headers = {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Headers': 'Content-Type',\n    'Access-Control-Allow-Methods': 'GET, OPTIONS',\n    'Content-Type': 'application/json',\n    // Cache for 1 hour\n    'Cache-Control': 'public, max-age=3600, s-maxage=3600',\n  };\n\n  // Handle preflight requests\n  if (event.httpMethod === 'OPTIONS') {\n    return { statusCode: 200, headers, body: '' };\n  }\n\n  // Only allow GET requests\n  if (event.httpMethod !== 'GET') {\n    return {\n      statusCode: 405,\n      headers,\n      body: JSON.stringify({ error: 'Method not allowed' }),\n    };\n  }\n\n  try {\n    const locationId = process.env.GMB_LOCATION_ID;\n\n    if (!locationId) {\n      throw new Error('GMB_LOCATION_ID not configured');\n    }\n\n    // Get fresh access token\n    const accessToken = await refreshAccessToken();\n\n    // Fetch reviews from GMB API v4\n    const gmbData = await fetchGoogleReviews(accessToken, locationId);\n\n    // Transform to frontend format\n    const reviewData = transformReviews(gmbData);\n\n    return {\n      statusCode: 200,\n      headers,\n      body: JSON.stringify(reviewData),\n    };\n  } catch (error) {\n    console.error('Error fetching Google reviews:', error);\n\n    return {\n      statusCode: 500,\n      headers,\n      body: JSON.stringify({\n        error: 'Failed to fetch reviews',\n        message: error.message,\n      }),\n    };\n  }\n};"],
  "mappings": "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",
  "names": []
}
